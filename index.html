<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>Family-Chat</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
    <div href="" class="container"> 
        <div id="chatHeader">Family-Chat
            <div id="logOut">log-out</div>
        </div>
        <div id="loginForm">
            <div id="logIn">Log-in
            </div>
            <table id="loginTable01">
                <tr>
                    <td class="td01">e-mailï¼š</td>
                    <td class="td02"><input id="emailAddress" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required/></td>
                </tr>
                <tr>
                    <td class="td01">passwordï¼š</td>
                    <td class="td02"><input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required/></td>
                </tr>
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ä¿å­˜ã™ã‚‹ã«ã¯Firebase Authenticationã§ã¯ãƒ€ãƒ¡ã§ã€Firestoreã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚æ–­å¿µğŸ’€ -->
                <!-- <tr>
                    <td class="td01">user-nameï¼š</td>
                    <td class="td02"><input id="userName" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" type=""></td>
                </tr> -->
            </table>
            <table id="loginTable02">
                <tr>
                    <td><button id="register">NEW ACCOUT</button></td>
                    <td><button id="login">LOGIN</button></td>
                </tr>
            </table>
        </div>
        <div class="chatBox">
            <div class="chatArea">
                <div id="output"></div>
            </div>
        </div>
    </div>
    <footer>
        <div id="unameText">
            <div>
                <input type="text" id="uname">
            </div>
            <div class="messageArea">
                <textarea name="" id="text"></textarea>
                <dig id="send"><img src="imgs/send.png" alt="" id="sendIcon"></dig>
            </div>
        </div>
    </footer>
    
    <!--/ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- JQuery -->


    <!--** ä»¥ä¸‹Firebase **-->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved }
            from "https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-database.js";
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆFirebase Authenticationï¼‰
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserSessionPersistence }
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // import { getAuth, signInWithEmailAndPassword }
        //     from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // import { getAuth, signInWithEmailAndPassword }
        //     from "https://www.gstatic.com/firebasejs/ui/10.7.1/firebase-ui-auth.js";
        // Your web app's Firebase configuration

        const firebaseConfig = {
            apiKey: "AIzaSyBLaMK-GlFo7KMSWOnY5YPpHftOAaPaHtQ",
            authDomain: "fir-test-9845e.firebaseapp.com",
            projectId: "fir-test-9845e",
            storageBucket: "fir-test-9845e.appspot.com",
            messagingSenderId: "648307675578",
            appId: "1:648307675578:web:770ad2e1f5ff0ab10f8d83"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å‚ç…§ã‚’ä½œæˆ
        const db = getDatabase(app);
        const dbRef = ref( db , "chat" );
        
        // ä»¥ä¸‹ã¯æœ€çµ‚çš„ã«å‰Šé™¤ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã®UIDå–å¾—æ¤œè¨¼ç”¨ç”¨ã«ã‚»ãƒƒãƒˆï¼ˆç¾çŠ¶ãƒ­ã‚°ã‚¤ãƒ³ä¿æŒã§ãã¦ã„ãªã„ãŸã‚ãƒ€ãƒ¡ğŸ’€ï¼‰
        let auth = getAuth();
        console.log(auth);
        let lastNotifiedUid = auth.lastNotifiedUid;
        console.log(lastNotifiedUid);
        $(document).ready(function(){ 
            let auth = getAuth();
            console.log(auth);
            let lastNotifiedUid = auth.lastNotifiedUid;
            console.log(lastNotifiedUid);
            console.log(dbRef);
        })

        // ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¾ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒªã‚¢ã‚’éš ã™
        $("#unameText").hide();
        $("#uname","#text").prop("disabled",true);
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–°è¦ç™»éŒ²
        $("#register").on("click",function(){
            let email = $("#emailAddress").val();
            let password = $("#password").val();
            let displayName = $("#userName").val();
            let auth = getAuth();
            createUserWithEmailAndPassword(auth, email, password, displayName).then((userCredential) => {
                let user = userCredential.user;
                let uid = user.uid;
                console.log(user);
                console.log(uid);
            }).catch((error) => {
                let errorCode = error.code;
                let errorMessage = error.message;
                console.log(errorCode);
                console.log(errorMessage);
            });
            console.log(auth);
        });

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ä¿æŒ1ï¸âƒ£ï¼ˆã§ããªã„ãƒ»ãƒ»ãƒ»ğŸ’€ï¼‰
        // setPersistence(auth, browserSessionPersistence).then(() => {
        //     $("#login").on("click",function(){
        //         let email = $("#emailAddress").val();
        //         let password = $("#password").val();        
        //         let auth = getAuth();
        //         signInWithEmailAndPassword(auth, email, password).then((userCredential) => {
        //             let user = userCredential.user;
        //             let uid = user.uid;
        //             console.log(user);
        //             console.log(uid);
        //             // ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‚‰UIDã‚’textareaã®nameå±æ€§ã«ä»˜ä¸ã™ã‚‹
        //             let loginUid = $(text).attr("name",uid);
        //             console.log(loginUid);
        //         }).catch((error) => {
        //             let errorCode = error.code;
        //             let errorMessage = error.message;
        //             console.log(errorCode);
        //             console.log(errorMessage);
        //         });
        //     });
        // })

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ä¿æŒ2ï¸âƒ£ï¼ˆã§ããªã„ãƒ»ãƒ»ãƒ»ğŸ’€ï¼‰
        // onAuthStateChanged(auth,(user) => {
        //     if(user) {
        //         let uid = user.uid;
        //         db.collection("users").doc(uid).get().then(function(doc) {
        //             if(doc.exists) {
        //                 let userData = doc.data();
        //                 $("#userData").html("UserData:" + JSON.stringify(userData));
        //             } else {
        //                 console.log("NO such document!");
        //             }
        //         }).catch(function(error){
        //             console.error("Error getting document:", error);
        //         });
        //     } else {
        //         console.log("User is logged out");
        //     }
        // });

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰...ã®è¨­å®š
        $("#send").on("click",function() {
            // textãŒç©ºã®å ´åˆã¯å‡¦ç†ã‚’ã‚„ã‚ã‚‹
            // .trim()ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§è¦‹ãˆãªã„ç©ºç™½ã‚’å‰Šé™¤ã—ã€æ”¹è¡Œã•ã‚Œã¦ã„ã¦ã‚‚textãŒç©ºã§ã‚ã‚Œã°é€ä¿¡ä¸å¯ã«ãªã‚‹
            let textCheck = $("#text").val().trim()
            console.log(textCheck);
            if ( textCheck == ""){
                return;
            }
            // unameã«ã‚ˆã£ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰ãˆã‚‹
            let userIcon = "";
            if ( $("#uname").val() == "ãƒãƒ¼ã‚º" ){
                userIcon = `<img src = "imgs/iconBearV2.png" class="userIcon">`
                console.log(userIcon);
            } else if ( $("#uname").val() !== "ãƒãƒ¼ã‚º" ){
                userIcon = `<img src = "imgs/iconV2.png" class="userIcon">`
                console.log(userIcon);
            }
            // é€ä¿¡æ™‚é–“ã®ãƒ­ã‚°ã‚’å–ã‚‹
            let now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth() + 1 ;
            let date = now.getDate();
            // æ›œæ—¥ã‚’é…åˆ—ä½¿ã£ã¦å–å¾—ã™ã‚‹
            let dayOfWeek = now.getDay();
            let dayOfWeekArry = ["(æ—¥)","(æœˆ)","(ç«)","(æ°´)","(æœ¨)","(é‡‘)","(åœŸ)"][dayOfWeek];
            let hours = now.getHours();
            let minutes = now.getMinutes();
            // minutesãŒä¸€æ¡ã®å ´åˆã€é ­ã«"0"ã‚’ä»˜ã‘ã‚‹
            minutes = String(minutes).padStart(2,"0");
            console.log(minutes);
            let nowCV = year + "/" + month + "/" + date + dayOfWeekArry + " " + hours + ":" + minutes;
            console.log(nowCV);
            const msg = {
                nowCV,
                userIcon,
                uname: $("#uname").val(),
                // loginUidã‚’ä»¥ä¸‹ã§textareaã«ã‚»ãƒƒãƒˆ
                loginUid: $("#text").attr("name"),
                text: $("#text").val(),
            };
            // console.log(msg);
            const newPostRef = push(dbRef);
            console.log(newPostRef);
            set(newPostRef, msg);
            // ä»¥ä¸‹ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã—ãŸã¨ãã«chatAreaã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æœ€ä¸‹éƒ¨ã«ã™ã‚‹
            $(".chatArea").scrollTop($(".chatArea")[0].scrollHeight);
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã—ãŸã‚‰textã‚’ç©ºã«ã™ã‚‹
            $("#text").val("");
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã—ãŸå¾Œã¯textã‚’Focusã™ã‚‹ã€‚
            $("#text").focus();
        });
    
    // ç†Šã•ã‚“ã‚¢ã‚¤ã‚³ãƒ³ã®å¤‰æ•°
    // let iconBear = `<img src = imgs/iconBearV2.png class="userIcon">`

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‚‰Chatã‚’è¡¨ç¤ºã•ã›ã‚‹ï¼‰
    $("#login").on("click",function(){
        let email = $("#emailAddress").val();
        let password = $("#password").val();        
        let auth = getAuth();
        $("#loginForm").hide();
        $("#unameText").show();
        signInWithEmailAndPassword(auth, email, password).then((userCredential) => {
            let user = userCredential.user;
            let uid = user.uid;
            console.log(user);
            console.log(uid);
            // ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‚‰UIDã‚’textareaã®nameå±æ€§ã«ä»˜ä¸ã™ã‚‹
            let loginUid = $(text).attr("name",uid);
            console.log(loginUid);
        }).catch((error) => {
            let errorCode = error.code;
            let errorMessage = error.message;
            console.log(errorCode);
            console.log(errorMessage);
        }).then(function(){
            onChildAdded(dbRef, function (data) {
                console.log(auth);
                // authå†…ã®lastNotifiedUidã«loginUIDã‚’ç™ºè¦‹ã—ã¾ã—ãŸğŸ’¡
                let lastNotifiedUid = auth.lastNotifiedUid;
                console.log(lastNotifiedUid);
                console.log(data);
                console.log(data.val());
                const msg = data.val(); //val()ã«ã‚ˆã‚Škeyã®ä¸­èº«ã®ãƒ‡ãƒ¼ã‚¿ãŒå–ã‚Šå‡ºã›ã‚‹ã€‚
                const key = data.key;
                console.log(key);
                console.log($(text).attr("name"));
                if( msg.loginUid == lastNotifiedUid && lastNotifiedUid !== "") {
                    let h = `<div id="${key}" class="message00">`
                    h += `<p id="dataUname00">`
                    h += msg.uname;
                    h += `</p><p id="dataTextNowCV00"><span id="dataIcon">`
                    // h += msg.userIcon;
                    h += `</span><span id="dataNowCV00">`
                    h += msg.nowCV
                    h += `</span><span id="dataText00">`
                    h += msg.text
                    h += `</span></p></div>`
                    // #output ã®æœ€å¾Œã«è¿½åŠ 
                    $("#output").append(h);
                    // ä»¥ä¸‹ã§ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸã¨ãã«chatAreaã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æœ€ä¸‹éƒ¨ã«ã™ã‚‹
                    // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å·®ã—è¾¼ã‚“ã ã“ã¨ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒãšã‚Œã¦ã—ã¾ã†ğŸ’¡
                    $(".chatArea").scrollTop($(".chatArea")[0].scrollHeight)
                } else if ( msg.loginUid !== lastNotifiedUid ) {
                    let h = `<div id="${key}" class="message">`
                    h += `<p id="dataUname">`
                    h += msg.uname;
                    h += `</p><p id="dataTextNowCV"><span id="dataIcon">`
                    h += msg.userIcon;
                    h += `</span><span id="dataText">`
                    h += msg.text
                    h += `</span><span id="dataNowCV">`
                    h += msg.nowCV
                    h += `</span></p></div>`
                    $("#output").append(h); // #output ã®æœ€å¾Œã«è¿½åŠ 
                    // ä»¥ä¸‹ã§ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸã¨ãã«chatAreaã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æœ€ä¸‹éƒ¨ã«ã™ã‚‹
                    // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å·®ã—è¾¼ã‚“ã ã“ã¨ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒãšã‚Œã¦ã—ã¾ã†ğŸ’¡
                    $(".chatArea").scrollTop($(".chatArea")[0].scrollHeight)
                };
            });
        })
    });

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰å‰Šé™¤ã™ã‚‹
    $("#output").on("click", ".message" ,function(){
        // alert("ã‚¯ãƒªãƒƒã‚¯ã§ããŸã­");
        const clickMsg = $(this).attr("id");
        console.log(clickMsg);
        const chatRef = ref (db, "chat/" + clickMsg );
        remove(chatRef);
        $("#removeMsg").remove();
    });
    $("#output").on("click", ".message00" ,function(){
        // alert("ã‚¯ãƒªãƒƒã‚¯ã§ããŸã­");
        const clickMsg = $(this).attr("id");
        console.log(clickMsg);
        const chatRef = ref (db, "chat/" + clickMsg );
        remove(chatRef);
        $("#removeMsg").remove();
    });

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰Firebaseã®ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã™ã‚‹
    onChildRemoved(dbRef, function(data) {
        console.log(data.val());
        const removeMsg = data.key;
        console.log(removeMsg)
        $("#"+ removeMsg).remove();
    });

    // Enterã‚­ãƒ¼(which===13)ã‚’æŠ¼ã™ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã§ãã‚‹
    // keyupã ã¨IMEç¢ºå®šæ™‚ã®Enterã§é€ä¿¡ã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã€keydownã¨ã™ã‚‹
    $("#text").on("keydown",function(event){
        // && !e.shihtKeyã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ Shiftã‚­ãƒ¼ï¼‹Enterã‚­ãƒ¼ ã®å ´åˆã¯æ”¹è¡Œ
        if (event.which === 13 && !event.shiftKey){
            $("#send").click()
        }
    });

    // textãŒç©ºã®å ´åˆã¯Enterã‚­ãƒ¼æŠ¼ã—ã¦ã‚‚æ”¹è¡Œã§ããªã„ã‚ˆã†ã«ã™ã‚‹ã€‚
    // ä½†ã—ã€Shiftã‚­ãƒ¼ï¼‹Enterã‚­ãƒ¼ ã‚’æŠ¼ã›ã°æ”¹è¡Œã¯ã§ãã‚‹ã€‚
    $("#text").on("keydown",function(event){
        if ($("#text").val()=="" && event.which === 13 && !event.shiftKey){    
            event.preventDefault();
        }
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ä¿æŒ3ï¸âƒ£ï¼ˆã§ããªã„ãƒ»ãƒ»ãƒ»ğŸ’€ï¼‰
    setPersistence(auth, browserSessionPersistence).then(() => {
        signInWithEmailAndPassword(auth, email, password);
    }).catch((error) => {
        let errorCode = error.code;
        let errorMessage = error.message;
    });

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã®è¨­å®š
    $("#logOut").on("click",function(){
        auth.signOut().then(() => {
            console.log("Successfully signed out");
        }).catch((error) => {
            ("Sign out error:", error);
        });
        location.reload();
    });


    </script>

</body>

</html>